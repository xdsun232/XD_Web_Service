# 就诊预约系统上机报告

## 一、开发环境搭建及主要问题

### 1.1 开发环境搭建过程

**系统环境要求：**
- 操作系统：Windows/macOS/Linux
- Node.js版本：14.0+
- 包管理器：npm 6.0+

**搭建步骤：**

1. **Node.js环境安装**
   ```bash
   # 检查Node.js版本
   node --version

   # 检查npm版本
   npm --version
   ```

2. **项目初始化**
   ```bash
   # 创建项目目录
   mkdir "web homework"
   cd "web homework"

   # 创建服务端目录
   mkdir server
   mkdir client
   ```

3. **服务端依赖安装**
   ```bash
   cd server
   npm init -y
   npm install express cors
   ```

4. **开发环境配置**
   - 配置CORS跨域支持
   - 设置端口号环境变量
   - 配置静态资源服务

### 1.2 遇到的主要问题及解决方案

**问题1：CORS跨域问题**
- **问题描述**：前端页面无法访问后端API接口
- **原因分析**：前后端分离架构存在跨域访问限制
- **解决方案**：
  ```javascript
  // 服务端配置CORS中间件
  const cors = require("cors");
  app.use(cors());
  ```

**问题2：数据持久化问题**
- **问题描述**：服务器重启后预约数据丢失
- **原因分析**：使用内存存储，数据无法持久化
- **临时解决方案**：通过ensureSchedule函数管理数据生命周期
- **改进方向**：可接入MySQL、MongoDB等数据库

**问题3：日期格式处理问题**
- **问题描述**：前端日期选择器与后端日期格式不匹配
- **解决方案**：
  ```javascript
  // 统一日期格式化函数
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }
  ```

**问题4：手机号验证规则**
- **问题描述**：需要验证中国手机号码格式
- **解决方案**：
  ```javascript
  // 正则表达式验证手机号
  function isValidPhone(phone) {
    return /^1[3-9]\d{9}$/.test(phone);
  }
  ```

## 二、服务端实现步骤和部署过程

### 2.1 服务端架构设计

**技术栈选择：**
- 后端框架：Node.js + Express.js
- 中间件：CORS（跨域处理）
- 数据存储：内存存储（简单高效）

**核心模块结构：**
```
server/
├── index.js          # 主服务文件
├── package.json      # 依赖配置
└── node_modules/     # 依赖包
```

### 2.2 API接口设计与实现

**RESTful API接口设计：**

1. **预约接口** `POST /api/appointment/book`
   ```javascript
   app.post("/api/appointment/book", (req, res) => {
     const { date, department, phone } = req.body || {};
     // 参数验证、业务逻辑处理、响应结果
   });
   ```

2. **取消预约接口** `POST /api/appointment/cancel`
   ```javascript
   app.post("/api/appointment/cancel", (req, res) => {
     const { phone } = req.body || {};
     // 手机号验证、预约查找、取消处理
   });
   ```

3. **查询号源接口** `GET /api/appointment/availability`
   ```javascript
   app.get("/api/appointment/availability", (req, res) => {
     // 获取所有科室号源信息，返回可用和已预约数量
   });
   ```

### 2.3 核心业务逻辑实现

**数据结构设计：**
```javascript
const store = {
  appointments: {},        // 科室-日期-预约记录映射
  phoneToAppointment: {}   // 手机号-预约信息映射
};

const DEPARTMENTS = {
  内科: { name: "内科", maxSlots: 10 },
  外科: { name: "外科", maxSlots: 10 },
};
```

**关键算法实现：**

1. **预约时间窗口管理**
   ```javascript
   function getBookingWindow() {
     const today = new Date();
     const tomorrow = new Date(today);
     tomorrow.setDate(today.getDate() + 1);
     const dayAfterTomorrow = new Date(today);
     dayAfterTomorrow.setDate(today.getDate() + 2);
     return [formatDate(tomorrow), formatDate(dayAfterTomorrow)];
   }
   ```

2. **数据清理机制**
   ```javascript
   function ensureSchedule() {
     // 清理过期预约数据
     // 初始化新日期的预约数组
     // 同步不同数据结构间的一致性
   }
   ```

### 2.4 服务部署过程

**部署步骤：**

1. **环境准备**
   ```bash
   cd server
   npm install  # 安装依赖
   ```

2. **启动服务**
   ```bash
   # 开发模式（热重载）
   npm run dev

   # 生产模式
   npm start
   ```

3. **服务验证**
   ```bash
   # 检查服务状态
   curl http://localhost:3000/api/appointment/availability
   ```

**部署配置：**
- 默认端口：3000（可通过PORT环境变量修改）
- 启动脚本：package.json中配置start和dev命令
- 跨域配置：支持所有来源的跨域请求

## 三、客户端调用构建过程

### 3.1 前端架构设计

**技术选择：**
- UI框架：Bootstrap 5.3.3（CDN引入）
- JavaScript：原生ES6+
- 通信方式：Fetch API
- 页面结构：单页面应用（SPA）

**文件结构：**
```
client/
├── index.html      # 主页面
├── app.js         # 业务逻辑
└── styles.css     # 样式文件
```

### 3.2 用户界面设计与实现

**页面布局：**
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>就诊预约系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- 预约表单区域 -->
    <!-- 取消预约表单区域 -->
    <!-- 号源查询表格区域 -->
    <!-- 消息提示区域 -->
</body>
</html>
```

**核心功能模块：**

1. **预约表单模块**
   ```javascript
   bookingForm.addEventListener("submit", async (event) => {
     event.preventDefault();
     const date = bookingDateInput.value;
     const department = bookingDepartmentSelect.value;
     const phone = bookingPhoneInput.value.trim();

     // 表单验证
     // API调用
     // 结果处理
   });
   ```

2. **取消预约模块**
   ```javascript
   cancelForm.addEventListener("submit", async (event) => {
     // 手机号验证
     // 取消请求发送
     // 界面更新
   });
   ```

3. **号源查询模块**
   ```javascript
   async function fetchAvailability() {
     const response = await fetch(`${API_BASE}/availability`);
     const result = await response.json();
     renderAvailability(result.data);
   }
   ```

### 3.3 前后端通信实现

**API调用封装：**
```javascript
const API_BASE = "http://localhost:3000/api/appointment";

// 预约请求
const response = await fetch(`${API_BASE}/book`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ date, department, phone }),
});

// 取消请求
const response = await fetch(`${API_BASE}/cancel`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ phone }),
});
```

**错误处理机制：**
```javascript
try {
  const response = await fetch(url, options);
  const result = await response.json();
  if (response.ok && result.success) {
    showMessage("success", result.message);
  } else {
    showMessage("danger", result.message || "操作失败");
  }
} catch (error) {
  showMessage("danger", error.message || "网络请求出错");
}
```

### 3.4 用户体验优化

**表单验证：**
- 实时手机号格式验证
- 日期选择范围限制
- 必填字段检查

**界面反馈：**
- Bootstrap Alert组件显示操作结果
- 表单提交后自动重置
- 号源表格实时更新

**响应式设计：**
- Bootstrap栅格系统
- 移动端友好布局
- 触摸设备优化

## 四、运行结果截图和文字说明

### 4.1 系统主界面展示

**[截图位置1：系统主界面]**
- 说明：显示完整的预约系统界面，包含预约表单、取消表单和号源查询表格
- 界面布局清晰，三个功能模块分区明确

### 4.2 预约功能演示

**[截图位置2：预约成功界面]**
- 说明：用户填写完整的预约信息（日期、科室、手机号）后提交
- 成功提示："预约成功"，表单自动重置，号源表格更新显示最新预约情况

**[截图位置3：预约失败情况]**
- 说明：当手机号已存在预约时，显示错误提示："该手机号已预约"
- 或者当号源已满时，提示："暂无预约号"

### 4.3 取消预约功能演示

**[截图位置4：取消预约成功]**
- 说明：输入已预约的手机号，成功取消预约
- 显示成功提示："取消预约成功"，号源表格相应可用数量增加

**[截图位置5：取消预约失败]**
- 说明：输入未预约的手机号，显示错误："该手机号无预约"

### 4.4 号源查询功能展示

**[截图位置6：号源查询表格]**
- 说明：实时显示各科室明后两天的号源情况
- 表格包含：科室名称、日期、可用号源数、已预约数
- 数据动态更新，反映最新的预约状态

### 4.5 边界情况测试

**[截图位置7：日期选择限制]**
- 说明：日期选择器自动限制可选范围，只能选择明天和后天
- 超出范围的日期无法选择，确保业务规则执行

**[截图位置8：手机号格式验证]**
- 说明：输入无效手机号格式时，前端验证提示："请输入有效的11位手机号"
- 阻止无效数据提交到后端

## 五、本次大作业总结

### 5.1 技术实现亮点

**1. 前后端分离架构**
- 采用RESTful API设计，前后端职责分离
- 前端专注于用户交互和界面展示
- 后端专注于业务逻辑和数据处理

**2. 完整的业务逻辑实现**
- 预约时间窗口控制（仅限明后两天）
- 手机号唯一性约束（一机一约）
- 科室号源数量管理
- 数据一致性维护

**3. 良好的用户体验设计**
- Bootstrap响应式布局
- 实时表单验证
- 友好的错误提示
- 界面自动更新

**4. 代码结构清晰**
- 模块化设计，功能分离
- 统一的错误处理机制
- 可维护的代码组织

### 5.2 技术难点与解决方案

**难点1：跨域访问问题**
- **挑战**：前后端分离导致的CORS限制
- **解决**：配置Express CORS中间件，允许跨域请求

**难点2：数据一致性维护**
- **挑战**：多个数据结构间需要保持同步
- **解决**：设计ensureSchedule函数，统一管理数据生命周期

**难点3：日期处理复杂性**
- **挑战**：时区、格式转换、范围验证
- **解决**：统一的日期处理函数，前后端一致性验证

**难点4：并发访问控制**
- **挑战**：多个用户同时预约可能产生竞态条件
- **当前方案**：简单内存锁机制
- **改进方向**：数据库事务处理

### 5.3 心得体会

**1. 全栈开发经验**
通过本次项目，深入理解了前后端分离架构的设计思路，掌握了从需求分析到系统实现的完整开发流程。

**2. API设计能力**
学习了RESTful API的设计原则，理解了接口设计的重要性，包括参数验证、错误处理、响应格式等。

**3. 用户体验意识**
认识到前端用户体验的重要性，通过表单验证、错误提示、界面反馈等细节提升用户满意度。

**4. 问题解决能力**
在开发过程中遇到的各种技术问题，锻炼了独立思考和解决问题的能力，学会了查阅文档和调试技巧。

### 5.4 不足与改进方向

**当前系统局限性：**

1. **数据持久化不足**
   - 当前使用内存存储，服务重启数据丢失
   - 改进方向：接入MySQL/MongoDB数据库

2. **并发处理能力有限**
   - 单线程处理，高并发性能有限
   - 改进方向：使用集群模式或负载均衡

3. **安全机制欠缺**
   - 缺乏用户认证和权限控制
   - 改进方向：添加JWT认证，实现用户系统

4. **监控和日志缺失**
   - 缺乏系统监控和日志记录
   - 改进方向：集成日志系统，添加监控指标

**功能扩展建议：**

1. **高级预约功能**
   - 支持多时段预约
   - 医生选择功能
   - 预约提醒服务

2. **管理后台**
   - 预约数据统计
   - 科室管理功能
   - 用户管理界面

3. **移动端适配**
   - 响应式设计优化
   - PWA支持
   - 微信小程序版本

### 5.5 总结

本次就诊预约系统的开发，不仅锻炼了Web全栈开发技能，更重要的是培养了系统化思维和工程化意识。从需求分析、架构设计到编码实现、测试部署，完整地经历了一个项目的生命周期。

项目虽然功能相对简单，但涵盖了现代Web开发的核心要素：RESTful API设计、前后端分离、用户体验优化、错误处理机制等。这些经验为后续更复杂项目的开发奠定了坚实的基础。

通过这次实践，深刻体会到软件开发不仅是技术实现，更是对用户需求的理解和满足。好的系统应该是技术先进、功能完善、体验优秀的综合体。在今后的学习和工作中，将继续深化技术学习，提升工程实践能力，开发出更加优秀的软件产品。